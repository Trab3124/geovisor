<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Geovisor de Avance Catastral</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { margin:0; font-family: Arial; }

header{
  background:#1e40af;
  color:white;
  padding:14px 20px;
  font-size:20px;
  font-weight:bold;
}

#map { height: calc(100vh - 65px); }

/* PANEL CAPAS */
#layerPanel{
  position:absolute;
  top:80px;
  left:10px;
  width:220px;
  background:white;
  padding:10px;
  border-radius:8px;
  box-shadow:0 3px 10px rgba(0,0,0,0.4);
  z-index:1000;
  font-size:13px;
}

/* PANEL FILTROS */
#filterPanel{
  position:absolute;
  top:80px;
  right:10px;
  width:300px;
  background:white;
  padding:10px;
  border-radius:8px;
  box-shadow:0 3px 10px rgba(0,0,0,0.4);
  z-index:1000;
  font-size:13px;
  max-height:80vh;
  overflow:auto;
}

.grupo{
  margin-bottom:10px;
  border-bottom:1px solid #ddd;
}

.grupo h4{
  margin:5px 0;
  cursor:pointer;
  background:#2563eb;
  color:white;
  padding:5px;
  border-radius:4px;
  font-size:13px;
}

.contenido{ display:none; margin-top:5px; }

input{
  width:100%;
  margin-bottom:5px;
  padding:4px;
}

button{
  width:100%;
  background:#2563eb;
  color:white;
  border:none;
  padding:5px;
  cursor:pointer;
}

/* PANEL ATRIBUTOS */
#infoPanel{
  position:absolute;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  width:500px;
  max-height:250px;
  overflow:auto;
  background:white;
  border-radius:8px;
  box-shadow:0 3px 10px rgba(0,0,0,0.4);
  z-index:1000;
  display:none;
  font-size:12px;
}

#infoHeader{
  background:#f3f4f6;
  padding:8px;
  font-weight:bold;
  display:flex;
  justify-content:space-between;
}

#closeBtn{ cursor:pointer; color:red; }

table{
  width:100%;
  border-collapse:collapse;
}

td{
  border:1px solid #ddd;
  padding:4px;
}
</style>
</head>
<body>

<header>Geovisor de Avance Catastral</header>
<div id="map"></div>

<!-- PANEL CAPAS -->
<div id="layerPanel">
<b>Capas</b><br><br>
<label><input type="checkbox" id="chk_sector" checked> tg_sector</label><br>
<label><input type="checkbox" id="chk_manzana" checked> tg_manzana</label><br>
<label><input type="checkbox" id="chk_lote" checked> tg_lote</label><br>
<label><input type="checkbox" id="chk_edifica" checked> tg_edifica</label><br>
<label><input type="checkbox" id="chk_construccion" checked> tg_construccion</label><br>
<label><input type="checkbox" id="chk_puerta" checked> tg_puerta</label>
</div>

<!-- PANEL FILTROS -->
<div id="filterPanel">
<b>Filtros</b><br><br>

<div class="grupo">
<h4 onclick="toggle(this)">LT - tg_lote</h4>
<div class="contenido">
<input id="f_lote_mzn" placeholder="cod_mzna">
<input id="f_lote_cod" placeholder="cod_lote">
<button onclick="filtrar('lote')">Filtrar</button>
</div>
</div>

<div class="grupo">
<h4 onclick="toggle(this)">tg_edifica</h4>
<div class="contenido">
<input id="f_edi_mzn" placeholder="cod_mzna">
<input id="f_edi_cod" placeholder="cod_lote">
<button onclick="filtrar('edifica')">Filtrar</button>
</div>
</div>

<div class="grupo">
<h4 onclick="toggle(this)">tg_construccion</h4>
<div class="contenido">
<input id="f_con_mzn" placeholder="cod_mzna">
<input id="f_con_cod" placeholder="cod_lote">
<input id="f_con_piso" placeholder="cod_piso">
<button onclick="filtrar('construccion')">Filtrar</button>
</div>
</div>

<div class="grupo">
<h4 onclick="toggle(this)">tg_puerta</h4>
<div class="contenido">
<input id="f_pue_mzn" placeholder="cod_mzna">
<input id="f_pue_cod" placeholder="cod_lote">
<button onclick="filtrar('puerta')">Filtrar</button>
</div>
</div>

</div>

<!-- PANEL ATRIBUTOS -->
<div id="infoPanel">
<div id="infoHeader">
<span id="infoTitle"></span>
<span id="closeBtn">X</span>
</div>
<div id="infoContent"></div>
</div>

<script>

var map = L.map('map').setView([-11.99,-77.05],15);

L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
{maxZoom:22}
).addTo(map);

// -------- FUNCION ATRIBUTOS --------
function mostrarAtributos(props, nombreCapa){
document.getElementById("infoTitle").innerText = nombreCapa;
var html="<table>";
for(var k in props){
html+="<tr><td><b>"+k+"</b></td><td>"+props[k]+"</td></tr>";
}
html+="</table>";
document.getElementById("infoContent").innerHTML = html;
document.getElementById("infoPanel").style.display="block";
}
document.getElementById("closeBtn").onclick=function(){
document.getElementById("infoPanel").style.display="none";
};

// -------- FUNCION FILTRO --------
function aplicarFiltro(layer, campoValores){
layer.clearLayers();
L.geoJSON(layer.originalData,{
style: layer.options.style,
pointToLayer: layer.options.pointToLayer,
onEachFeature:(f,l)=>{
let cumple=true;
for(let campo in campoValores){
if(campoValores[campo] &&
f.properties[campo]!=campoValores[campo]) cumple=false;
}
if(cumple){
l.on("click",()=>mostrarAtributos(f.properties, layer.nombre));
layer.addLayer(l);
}
}
});
}

// -------- CARGA CAPAS --------
function cargar(url, estilo, nombre, tipo="polygon"){
return fetch(url)
.then(r=>r.json())
.then(data=>{
var layer=L.geoJSON(data,{
style: estilo,
pointToLayer: tipo==="point"
? (f,latlng)=>L.circleMarker(latlng,estilo)
: undefined,
onEachFeature:(f,l)=>{
l.on("click",()=>mostrarAtributos(f.properties,nombre));
}
});
layer.originalData=data;
layer.nombre=nombre;
return layer;
});
}

var sectorLayer,manzanaLayer,loteLayer,edificaLayer,construccionLayer,puertaLayer;

Promise.all([
cargar('data/tg_sector.geojson',{color:"#6b7280",weight:2,fill:false},"tg_sector"),
cargar('data/tg_manzana.geojson',{color:"#2563eb",weight:1,fill:false},"tg_manzana"),
cargar('data/tg_lote.geojson',{color:"#16a34a",weight:1,fillOpacity:0.4},"tg_lote"),
cargar('data/tg_edifica.geojson',{color:"#f59e0b",weight:1,fillOpacity:0.5},"tg_edifica"),
cargar('data/tg_construccion.geojson',{color:"#ef4444",weight:1,fillOpacity:0.6},"tg_construccion"),
cargar('data/tg_puerta.geojson',{radius:3,color:"#000"},"tg_puerta","point")
]).then(function(layers){

sectorLayer=layers[0].addTo(map);
manzanaLayer=layers[1].addTo(map);
loteLayer=layers[2].addTo(map);
edificaLayer=layers[3].addTo(map);
construccionLayer=layers[4].addTo(map);
puertaLayer=layers[5].addTo(map);

sectorLayer.bringToBack();
manzanaLayer.bringToFront();
loteLayer.bringToFront();
edificaLayer.bringToFront();
construccionLayer.bringToFront();
puertaLayer.bringToFront();

});

// -------- FILTRAR --------
function filtrar(tipo){

if(tipo==="lote"){
aplicarFiltro(loteLayer,{
cod_mzna:f_lote_mzn.value,
cod_lote:f_lote_cod.value
});
}

if(tipo==="edifica"){
aplicarFiltro(edificaLayer,{
cod_mzna:f_edi_mzn.value,
cod_lote:f_edi_cod.value
});
}

if(tipo==="construccion"){
aplicarFiltro(construccionLayer,{
cod_mzna:f_con_mzn.value,
cod_lote:f_con_cod.value,
cod_piso:f_con_piso.value
});
}

if(tipo==="puerta"){
aplicarFiltro(puertaLayer,{
cod_mzna:f_pue_mzn.value,
cod_lote:f_pue_cod.value
});
}
}

// -------- TOGGLE --------
function toggle(el){
let c=el.nextElementSibling;
c.style.display=c.style.display==="block"?"none":"block";
}

</script>
</body>
</html>



