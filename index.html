<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Geovisor de Avance Catastral</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { margin:0; font-family: Arial; }

header{
  background:#1e40af;
  color:white;
  padding:14px 20px;
  font-size:20px;
  font-weight:bold;
}

#map { height: calc(100vh - 65px); }

/* PANEL ATRIBUTOS SUPERIOR DERECHO */
#infoPanel{
  position:absolute;
  top:80px;
  right:10px;
  width:320px;
  background:white;
  border-radius:8px;
  box-shadow:0 3px 10px rgba(0,0,0,0.4);
  z-index:1000;
  display:none;
}

#infoHeader{
  background:#f3f4f6;
  padding:8px;
  font-weight:bold;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

#infoContent{
  padding:10px;
  max-height:350px;
  overflow:auto;
  font-size:12px;
}

#closeBtn{
  cursor:pointer;
  color:red;
  font-weight:bold;
}

/* PANEL CAPAS */
#layerPanel{
  position:absolute;
  top:80px;
  left:10px;
  width:220px;
  background:white;
  padding:10px;
  border-radius:8px;
  box-shadow:0 3px 10px rgba(0,0,0,0.4);
  z-index:1000;
  font-size:13px;
}

table{
  width:100%;
  border-collapse:collapse;
}

td{
  border:1px solid #ddd;
  padding:4px;
}
</style>
</head>
<body>

<header>Geovisor de Avance Catastral</header>

<div id="map"></div>

<!-- PANEL CAPAS -->
<div id="layerPanel">
  <b>Capas</b><br><br>
  <label><input type="checkbox" id="chk_sector" checked> tg_sector</label><br>
  <label><input type="checkbox" id="chk_manzana" checked> tg_manzana</label><br>
  <label><input type="checkbox" id="chk_lote" checked> tg_lote</label><br>
  <label><input type="checkbox" id="chk_edifica" checked> tg_edifica</label><br>
  <label><input type="checkbox" id="chk_construccion" checked> tg_construccion</label><br>
  <label><input type="checkbox" id="chk_puerta" checked> tg_puerta</label>
</div>

<!-- PANEL INFORMACIÓN -->
<div id="infoPanel">
  <div id="infoHeader">
    <span id="infoTitle">Capa</span>
    <span id="closeBtn">X</span>
  </div>
  <div id="infoContent"></div>
</div>

<script>

var map = L.map('map',{maxZoom:22,minZoom:5})
.setView([-11.99,-77.05],15);

L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
{maxZoom:22}
).addTo(map);

// -------- FUNCION MOSTRAR ATRIBUTOS --------
function mostrarAtributos(props, nombreCapa){

  document.getElementById("infoTitle").innerText = nombreCapa;

  var html="<table>";
  for(var k in props){
    html+="<tr><td><b>"+k+"</b></td><td>"+props[k]+"</td></tr>";
  }
  html+="</table>";

  document.getElementById("infoContent").innerHTML = html;
  document.getElementById("infoPanel").style.display="block";
}

document.getElementById("closeBtn").onclick=function(){
  document.getElementById("infoPanel").style.display="none";
};

// -------- CARGADOR GENERICO --------
function cargarGeoJSON(url, estilo, nombreCapa, tipo="polygon"){

  return fetch(url)
  .then(r=>r.json())
  .then(data=>{
    return L.geoJSON(data,{
      style: estilo,
      pointToLayer: tipo==="point"
        ? (f,latlng)=>L.circleMarker(latlng,estilo)
        : undefined,
      onEachFeature:(f,l)=>{
        l.on("click",function(e){
          L.DomEvent.stopPropagation(e);
          mostrarAtributos(f.properties, nombreCapa);
        });
      }
    });
  });
}

// -------- CARGA ORDENADA --------
var sectorLayer, manzanaLayer, loteLayer,
    edificaLayer, construccionLayer, puertaLayer;

Promise.all([

  cargarGeoJSON('data/tg_sector.geojson',
    {color:"#6b7280",weight:2,fill:false},"tg_sector"),

  cargarGeoJSON('data/tg_manzana.geojson',
    {color:"#2563eb",weight:1,fill:false},"tg_manzana"),

  cargarGeoJSON('data/tg_lote.geojson',
    {color:"#16a34a",weight:1,fillOpacity:0.4},"tg_lote"),

  cargarGeoJSON('data/tg_edifica.geojson',
    {color:"#f59e0b",weight:1,fillOpacity:0.5},"tg_edifica"),

  cargarGeoJSON('data/tg_construccion.geojson',
    {color:"#ef4444",weight:1,fillOpacity:0.6},"tg_construccion"),

  cargarGeoJSON('data/tg_puerta.geojson',
    {radius:3,color:"#000",fillOpacity:1},
    "tg_puerta","point")

]).then(function(layers){

  sectorLayer = layers[0].addTo(map);
  manzanaLayer = layers[1].addTo(map);
  loteLayer = layers[2].addTo(map);
  edificaLayer = layers[3].addTo(map);
  construccionLayer = layers[4].addTo(map);
  puertaLayer = layers[5].addTo(map);

  // ORDEN REAL (abajo → arriba)
  sectorLayer.bringToBack();
  manzanaLayer.bringToFront();
  loteLayer.bringToFront();
  edificaLayer.bringToFront();
  construccionLayer.bringToFront();
  puertaLayer.bringToFront();

});

// -------- TOGGLE CAPAS --------
function toggleLayer(id, layer){
  document.getElementById(id)
  .addEventListener("change",function(){
    if(this.checked){
      map.addLayer(layer);
    }else{
      map.removeLayer(layer);
    }
  });
}

setTimeout(function(){
  toggleLayer("chk_sector",sectorLayer);
  toggleLayer("chk_manzana",manzanaLayer);
  toggleLayer("chk_lote",loteLayer);
  toggleLayer("chk_edifica",edificaLayer);
  toggleLayer("chk_construccion",construccionLayer);
  toggleLayer("chk_puerta",puertaLayer);
},1000);

</script>
</body>
</html>



