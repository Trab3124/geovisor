<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Geovisor de Avance Catastral</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { margin:0; font-family: Arial; }

header{
  background:#1e40af;
  color:white;
  padding:14px 20px;
  font-size:20px;
  font-weight:bold;
}

#map { height: calc(100vh - 200px); }

#filtroPanel{
  position:absolute;
  right:10px;
  top:80px;
  width:300px;
  background:white;
  padding:10px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.3);
  z-index:1000;
}

#atributosPanel{
  height:150px;
  background:white;
  border-top:3px solid #1e40af;
  overflow:auto;
  padding:10px;
}

#atributosPanel h3{
  margin:0 0 5px 0;
  color:#1e40af;
  font-size:14px;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}

td{
  border:1px solid #ddd;
  padding:4px;
}

select{
  width:100%;
  margin-bottom:8px;
  padding:4px;
}
</style>
</head>
<body>

<header>Geovisor de Avance Catastral</header>

<div id="map"></div>

<div id="filtroPanel">
  <b>Filtrar Manzana</b>
  <select id="sectorSelect">
    <option value="">-- Sector --</option>
  </select>
  <select id="manzanaSelect">
    <option value="">-- Manzana --</option>
  </select>
</div>

<div id="atributosPanel"></div>

<script>

var map = L.map('map',{maxZoom:22,minZoom:5})
.setView([-11.99,-77.05],15);

L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
{maxZoom:22}
).addTo(map);

// ---------------- VARIABLES ----------------
var sectorLayer, manzanaLayer, loteLayer, puertaLayer;
var sectorData, manzanaData, loteData, puertaData;
var highlightLayer;

// ---------------- TABLA ATRIBUTOS ----------------
function mostrarAtributos(props, nombreCapa){
  var html="<h3>Tabla de atributos - "+nombreCapa+"</h3><table>";
  for(var k in props){
    html+="<tr><td><b>"+k+"</b></td><td>"+props[k]+"</td></tr>";
  }
  html+="</table>";
  document.getElementById("atributosPanel").innerHTML=html;
}

// ---------------- RESALTADO ----------------
function resaltar(feature, nombreCapa){

  if(highlightLayer){
    map.removeLayer(highlightLayer);
  }

  highlightLayer=L.geoJSON(feature,{
    style:{color:"red",weight:3,fillOpacity:0.1}
  }).addTo(map);

  map.fitBounds(highlightLayer.getBounds());

  highlightLayer.eachLayer(function(l){
    l.bindTooltip(Object.values(feature.properties)[0],{
      permanent:true,
      direction:"center"
    }).openTooltip();
  });

  mostrarAtributos(feature.properties, nombreCapa);
}

// ---------------- CARGAR SECTOR ----------------
fetch('data/tg_sector.geojson')
.then(r=>r.json())
.then(data=>{
  sectorData=data;

  sectorLayer=L.geoJSON(data,{
    style:{color:"#6b7280",weight:2,fill:false},
    onEachFeature:(f,l)=>{
      l.on("click",()=>resaltar(f,"SECTOR"));
    }
  }).addTo(map);

  var sectores=[...new Set(data.features.map(f=>f.properties.cod_sector))];
  sectores.sort().forEach(s=>{
    var opt=document.createElement("option");
    opt.value=s;
    opt.text=s;
    document.getElementById("sectorSelect").appendChild(opt);
  });
});

// ---------------- CARGAR MANZANA ----------------
fetch('data/tg_manzana.geojson')
.then(r=>r.json())
.then(data=>{
  manzanaData=data;

  manzanaLayer=L.geoJSON(data,{
    style:{color:"#2563eb",weight:1,fill:false},
    onEachFeature:(f,l)=>{
      l.on("click",()=>resaltar(f,"MANZANA"));
    }
  }).addTo(map);
});

// ---------------- CARGAR LOTE ----------------
fetch('data/tg_lote.geojson')
.then(r=>r.json())
.then(data=>{
  loteData=data;

  loteLayer=L.geoJSON(data,{
    style:{color:"#16a34a",weight:1,fillOpacity:0.4},
    onEachFeature:(f,l)=>{
      l.on("click",()=>resaltar(f,"LOTE"));
    }
  }).addTo(map);
});

// ---------------- CARGAR PUERTA ----------------
fetch('data/tg_puerta.geojson')
.then(r=>r.json())
.then(data=>{
  puertaData=data;

  puertaLayer=L.geoJSON(data,{
    pointToLayer:(f,latlng)=>
      L.circleMarker(latlng,{radius:3,color:"#000",fillOpacity:0.8}),
    onEachFeature:(f,l)=>{
      l.on("click",()=>resaltar(f,"PUERTA"));
    }
  }).addTo(map);
});

// ---------------- FILTRO SECTOR ----------------
document.getElementById("sectorSelect")
.addEventListener("change",function(){

  var val=this.value;
  var manzanaSelect=document.getElementById("manzanaSelect");
  manzanaSelect.innerHTML='<option value="">-- Manzana --</option>';

  if(!val) return;

  var manzanasFiltradas=
    manzanaData.features
    .filter(f=>f.properties.cod_sector==val);

  var codigos=[...new Set(
    manzanasFiltradas.map(f=>f.properties.cod_mzna)
  )];

  codigos.sort().forEach(m=>{
    var opt=document.createElement("option");
    opt.value=m;
    opt.text=m;
    manzanaSelect.appendChild(opt);
  });

});

// ---------------- FILTRO MANZANA ----------------
document.getElementById("manzanaSelect")
.addEventListener("change",function(){

  var val=this.value;
  if(!val) return;

  var feature=
    manzanaData.features
    .find(f=>f.properties.cod_mzna==val);

  resaltar(feature,"MANZANA");
});

</script>
</body>
</html>



