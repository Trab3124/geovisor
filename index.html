<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Geovisor de Avance Catastral</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { margin:0; font-family: Arial, sans-serif; }

header {
  background:#1e40af; /* Azul */
  color:white;
  padding:14px 20px;
  font-size:20px;
  font-weight:bold;
}

#map { height: calc(100vh - 65px); }

.control-box {
  background:white;
  padding:12px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
  width:220px;
}

select, input {
  width:100%;
  margin-top:6px;
  padding:6px;
  border-radius:4px;
  border:1px solid #ccc;
}
</style>
</head>
<body>

<header>
  Geovisor de Avance Catastral
</header>

<div id="map"></div>

<script>

var map = L.map('map');

var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

var manzanaLayer;
var lotesLayer;

// Estilos
function styleManzana() {
  return { color:"#1d4ed8", weight:2, fill:false };
}

function styleLotes() {
  return { color:"#16a34a", weight:1, fillOpacity:0.4 };
}

// Cargar Manzanas
fetch('data/manzana.geojson')
.then(res => res.json())
.then(data => {

  manzanaLayer = L.geoJSON(data, {
    style: styleManzana,
    onEachFeature: function(feature, layer){
      layer.bindPopup(
        "<b>Sector:</b> "+feature.properties.cod_sector+
        "<br><b>Manzana:</b> "+feature.properties.cod_manzana
      );
    }
  }).addTo(map);

  map.fitBounds(manzanaLayer.getBounds());
});

// Cargar Lotes
fetch('data/lotes.geojson')
.then(res => res.json())
.then(data => {

  lotesLayer = L.geoJSON(data, {
    style: styleLotes,
    onEachFeature: function(feature, layer){
      layer.bindPopup(
        "<b>Lote:</b> "+feature.properties.cod_lote+
        "<br><b>Manzana:</b> "+feature.properties.cod_manzana
      );
    }
  }).addTo(map);

});

// ðŸ”Ž BUSCADOR TIPO GOOGLE MAPS

var controlBusqueda = L.control({position:'topleft'});

controlBusqueda.onAdd = function(){

  var div = L.DomUtil.create('div','control-box');
  div.innerHTML = "<b>Buscar Lote</b>";

  var input = document.createElement("input");
  input.placeholder = "Ej: Mz 3 Lt 5";

  input.onkeydown = function(e){
    if(e.key === "Enter"){
      buscarLote(input.value);
    }
  };

  div.appendChild(input);

  return div;
};

controlBusqueda.addTo(map);

// FunciÃ³n de bÃºsqueda
function buscarLote(texto){

  if(!lotesLayer) return;

  var partes = texto.toLowerCase();

  var match = partes.match(/mz\s*(\d+).*lt\s*(\d+)/);

  if(!match){
    alert("Formato incorrecto. Ejemplo: Mz 3 Lt 5");
    return;
  }

  var manzanaBuscada = match[1];
  var loteBuscado = match[2];

  var encontrado = false;

  lotesLayer.eachLayer(function(layer){

    var mz = layer.feature.properties.cod_manzana.toString();
    var lt = layer.feature.properties.cod_lote.toString();

    if(mz == manzanaBuscada && lt == loteBuscado){

      map.fitBounds(layer.getBounds());

      layer.setStyle({color:"red", fillOpacity:0.8});

      layer.openPopup();

      encontrado = true;

    } else {
      layer.setStyle({color:"#16a34a", fillOpacity:0.4});
    }

  });

  if(!encontrado){
    alert("Lote no encontrado");
  }

}

</script>
</body>
</html>

</script>
</body>
</html>

