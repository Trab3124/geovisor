<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Geovisor de Avance Catastral</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<style>
body { margin:0; font-family: Arial; }

header{
  background:#1e40af;
  color:white;
  padding:14px 20px;
  font-size:20px;
  font-weight:bold;
}

#map { height: calc(100vh - 65px); }

#panel {
  position:absolute;
  right:10px;
  top:80px;
  width:320px;
  background:white;
  border-radius:8px;
  padding:10px;
  box-shadow:0 2px 8px rgba(0,0,0,0.3);
  max-height:420px;
  overflow:auto;
  z-index:1000;
}

#panel h3{
  margin:5px 0;
  font-size:14px;
  color:#1e40af;
}

select{
  width:100%;
  padding:5px;
  margin-bottom:10px;
}

.label-selected{
  font-size:14px;
  font-weight:bold;
  color:red;
  text-shadow:1px 1px 2px white;
}
</style>
</head>
<body>

<header>Geovisor de Avance Catastral</header>
<div id="map"></div>

<div id="panel">
  <h3>Filtrar por Sector</h3>
  <select id="sectorSelect">
    <option value="">-- Seleccione Sector --</option>
  </select>

  <h3>Filtrar por Manzana</h3>
  <select id="manzanaSelect">
    <option value="">-- Seleccione Manzana --</option>
  </select>

  <div id="info"></div>
</div>

<script>

var map = L.map('map',{maxZoom:22,minZoom:5})
.setView([-11.99,-77.05],15);

var osm = L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
{maxZoom:22}).addTo(map);

var sat = L.tileLayer(
'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
{maxZoom:22});

L.control.layers({"OSM":osm,"Satelital":sat}).addTo(map);

L.Control.geocoder({defaultMarkGeocode:true}).addTo(map);

var sectorLayer, manzanaLayer;
var sectorData, manzanaData;
var highlightLayer;

// ------------------ CARGAR SECTOR ------------------
fetch('data/tg_sector.geojson')
.then(r=>r.json())
.then(data=>{
  sectorData=data;

  sectorLayer=L.geoJSON(data,{
    style:{color:"#6b7280",weight:2,fill:false}
  }).addTo(map);

  // llenar combo sector
  var sectores=[...new Set(data.features.map(f=>f.properties.cod_sector))];
  sectores.sort().forEach(s=>{
    var opt=document.createElement("option");
    opt.value=s;
    opt.text=s;
    document.getElementById("sectorSelect").appendChild(opt);
  });
});

// ------------------ CARGAR MANZANA ------------------
fetch('data/tg_manzana.geojson')
.then(r=>r.json())
.then(data=>{
  manzanaData=data;

  manzanaLayer=L.geoJSON(data,{
    style:{color:"#2563eb",weight:1,fill:false}
  }).addTo(map);

  // llenar combo manzana
  var manzanas=[...new Set(data.features.map(f=>f.properties.cod_mzna))];
  manzanas.sort().forEach(m=>{
    var opt=document.createElement("option");
    opt.value=m;
    opt.text=m;
    document.getElementById("manzanaSelect").appendChild(opt);
  });
});

// ------------------ FUNCION ZOOM Y RESALTADO ------------------
function zoomToFeature(feature, tipo, campo){

  if(highlightLayer){
    map.removeLayer(highlightLayer);
  }

  highlightLayer=L.geoJSON(feature,{
    style:{
      color:"red",
      weight:3,
      fillOpacity:0.1
    }
  }).addTo(map);

  map.fitBounds(highlightLayer.getBounds());

  highlightLayer.eachLayer(function(layer){
    layer.bindTooltip(feature.properties[campo],{
      permanent:true,
      direction:"center",
      className:"label-selected"
    }).openTooltip();
  });

  document.getElementById("info").innerHTML=
    "<h3>Seleccionado: "+tipo+"</h3>";
}

// ------------------ EVENTO SECTOR ------------------
document.getElementById("sectorSelect").addEventListener("change",function(){

  var val=this.value;
  if(!val) return;

  var feature=sectorData.features.find(f=>f.properties.cod_sector==val);
  zoomToFeature(feature,"SECTOR","cod_sector");
});

// ------------------ EVENTO MANZANA ------------------
document.getElementById("manzanaSelect").addEventListener("change",function(){

  var val=this.value;
  if(!val) return;

  var feature=manzanaData.features.find(f=>f.properties.cod_mzna==val);
  zoomToFeature(feature,"MANZANA","cod_mzna");
});

</script>
</body>
</html>

