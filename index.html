<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Geovisor de Avance Catastral</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Geocoder -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<style>
body { margin:0; font-family: Arial, sans-serif; }

header {
  background:#1e40af;
  color:white;
  padding:14px 20px;
  font-size:20px;
  font-weight:bold;
}

#map { height: calc(100vh - 65px); }

/* Panel de atributos */
#panelAtributos {
  position:absolute;
  top:80px;
  right:10px;
  width:300px;
  max-height:400px;
  overflow:auto;
  background:white;
  padding:12px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.3);
  display:none;
  z-index:1000;
}

#panelAtributos h3 {
  margin-top:0;
}

table {
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}

td {
  border:1px solid #ddd;
  padding:4px;
}

.closeBtn {
  cursor:pointer;
  color:red;
  float:right;
  font-weight:bold;
}
</style>
</head>
<body>

<header>
Geovisor de Avance Catastral
</header>

<div id="map"></div>

<div id="panelAtributos">
  <span class="closeBtn" onclick="cerrarPanel()">X</span>
  <h3>Atributos</h3>
  <div id="contenidoAtributos"></div>
</div>

<script>

// ===========================
// MAPA
// ===========================

var map = L.map('map', {
  maxZoom: 22,
  minZoom: 5
}).setView([-11.99, -77.05], 15);

// Base OSM
var osm = L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  { maxZoom:22 }
).addTo(map);

// Satelital ESRI
var satelite = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  { maxZoom:22 }
);

L.control.layers(
  {"OpenStreetMap": osm, "Satelital": satelite},
  null,
  {collapsed:false}
).addTo(map);


// ===========================
// BUSCADOR
// ===========================

L.Control.geocoder({
  defaultMarkGeocode:true,
  placeholder:"Buscar dirección o lugar..."
}).addTo(map);


// ===========================
// PANEL ATRIBUTOS
// ===========================

function mostrarAtributos(propiedades){

  var contenido = "<table>";

  for(var key in propiedades){
    contenido += "<tr><td><b>"+key+"</b></td><td>"+propiedades[key]+"</td></tr>";
  }

  contenido += "</table>";

  document.getElementById("contenidoAtributos").innerHTML = contenido;
  document.getElementById("panelAtributos").style.display = "block";
}

function cerrarPanel(){
  document.getElementById("panelAtributos").style.display = "none";
}


// ===========================
// FUNCIÓN PARA CARGAR CAPAS
// ===========================

function cargarPoligono(url, estilo){

  fetch(url)
  .then(res => res.json())
  .then(data => {

    L.geoJSON(data,{
      style: estilo,
      onEachFeature: function(feature, layer){
        layer.on("click", function(){
          mostrarAtributos(feature.properties);
        });
      }
    }).addTo(map);

  });

}

function cargarPuntos(url){

  fetch(url)
  .then(res => res.json())
  .then(data => {

    L.geoJSON(data,{
      pointToLayer: function(feature, latlng){
        return L.circleMarker(latlng,{
          radius:3,
          color:"#000",
          fillColor:"#000",
          fillOpacity:0.9
        });
      },
      onEachFeature: function(feature, layer){
        layer.on("click", function(){
          mostrarAtributos(feature.properties);
        });
      }
    }).addTo(map);

  });

}


// ===========================
// CARGAR TUS CAPAS
// ===========================

cargarPoligono('data/tg_sector.geojson',
  {color:"#6b7280", weight:2, fill:false});

cargarPoligono('data/tg_manzana.geojson',
  {color:"#2563eb", weight:2, fill:false});

cargarPoligono('data/tg_lote.geojson',
  {color:"#16a34a", weight:1, fillOpacity:0.4});

cargarPoligono('data/tg_edifica.geojson',
  {color:"#f97316", weight:1});

cargarPoligono('data/tg_construccion.geojson',
  {color:"#dc2626", weight:1});

cargarPoligono('data/tg_construccion_2.geojson',
  {color:"#9333ea", weight:1});

cargarPuntos('data/tg_puerta.geojson');

cargarPoligono('data/uca.geojson',
  {color:"#0891b2", weight:1});

</script>
</body>
</html>
