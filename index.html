<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geovisor Catastral Profesional | Sistema Municipal</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --highlight-color: #f1c40f;
            --bg-light: #f8f9fa;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }

        #map { height: 100vh; width: 100vw; z-index: 1; }

        /* Paneles Generales */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-radius: 8px;
            box-shadow: var(--shadow);
            border: 1px solid #ddd;
            z-index: 1000;
            position: absolute;
        }

        /* Panel Izquierdo: Capas */
        #layer-control {
            top: 20px; left: 20px; width: 220px; padding: 15px;
        }

        /* Panel Derecho: Buscador */
        #search-panel {
            top: 20px; right: 20px; width: 280px; padding: 15px;
        }

        /* Panel Inferior: Atributos */
        #info-panel {
            bottom: -400px; left: 50%; transform: translateX(-50%);
            width: 80%; max-width: 1000px; height: 350px;
            transition: bottom 0.4s ease;
            padding: 20px; overflow-y: auto;
        }
        #info-panel.active { bottom: 20px; }

        h3 { margin-top: 0; font-size: 16px; color: var(--primary-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 5px; }

        .control-group { margin-bottom: 12px; }
        label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 5px; }
        select, button { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 13px; }
        
        button {
            background: var(--primary-color); color: white; border: none; cursor: pointer; transition: 0.3s;
            margin-top: 10px;
        }
        button:hover { background: var(--accent-color); }
        button.secondary { background: #95a5a6; }

        /* Estilos de Tabla */
        .table-container { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: var(--primary-color); color: white; padding: 8px; text-align: left; position: sticky; top: 0; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f2f2f2; }

        .close-btn { float: right; cursor: pointer; font-weight: bold; color: #e74c3c; }
        
        .layer-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 13px; }
        .layer-item input { margin-right: 10px; }

        .badge {
            background: var(--accent-color); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="layer-control" class="glass-panel">
        <h3>Capas Catastrales</h3>
        <div id="layer-list"></div>
    </div>

    <div id="search-panel" class="glass-panel">
        <h3>Buscador Jerárquico</h3>
        <div class="control-group">
            <label>Sector</label>
            <select id="sel-sector"><option value="">Seleccione Sector...</option></select>
        </div>
        <div class="control-group">
            <label>Manzana</label>
            <select id="sel-mzna" disabled><option value="">Seleccione Manzana...</option></select>
        </div>
        <div class="control-group">
            <label>Lote</label>
            <select id="sel-lote" disabled><option value="">Seleccione Lote...</option></select>
        </div>
        <button onclick="resetFilters()" class="secondary">Limpiar Filtros</button>
    </div>

    <div id="info-panel" class="glass-panel">
        <span class="close-btn" onclick="closeInfo()">✖ Cerrar</span>
        <h3 id="info-title">Información de Atributos</h3>
        <div id="info-content">
            <p>Seleccione un elemento en el mapa para ver sus detalles.</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        /**
         * CONFIGURACIÓN INICIAL
         */
        const map = L.map('map', {
            center: [-12.046374, -77.042793], // Coordenadas iniciales (ajustar según ciudad)
            zoom: 16,
            zoomControl: false
        });

        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // Mapa Base Profesional (CartoDB Positron)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO'
        }).addTo(map);

        // Definición de Capas y sus Estilos
        const layersConfig = [
            { id: 'tg_sector', name: 'Sectores', url: 'data/tg_sector.geojson', style: { color: '#2c3e50', weight: 3, fillOpacity: 0.1 }, zIndex: 10 },
            { id: 'tg_manzana', name: 'Manzanas', url: 'data/tg_manzana.geojson', style: { color: '#e67e22', weight: 2, fillOpacity: 0.1 }, zIndex: 20 },
            { id: 'tg_lote', name: 'Lotes', url: 'data/tg_lote.geojson', style: { color: '#27ae60', weight: 1, fillOpacity: 0.4 }, zIndex: 30 },
            { id: 'tg_edifica', name: 'Edificaciones', url: 'data/tg_edifica.geojson', style: { color: '#8e44ad', weight: 1, fillOpacity: 0.5 }, zIndex: 40 },
            { id: 'tg_construccion', name: 'Construcciones (Pisos)', url: 'data/tg_construccion.geojson', style: { color: '#c0392b', weight: 0.5, fillOpacity: 0.3 }, zIndex: 50 },
            { id: 'tg_puerta', name: 'Puertas/Accesos', url: 'data/tg_puerta.geojson', isPoint: true, zIndex: 60 }
        ];

        const geoLayers = {};
        let selectedFeature = null;

        /**
         * CARGA DE DATOS Y RENDERIZADO
         */
        async function loadLayers() {
            for (const config of layersConfig) {
                try {
                    const response = await fetch(config.url);
                    const data = await response.json();

                    geoLayers[config.id] = L.geoJSON(data, {
                        style: config.style,
                        pointToLayer: (feature, latlng) => {
                            return config.isPoint ? L.circleMarker(latlng, { radius: 4, fillColor: "#333", color: "#fff", weight: 1, fillOpacity: 1 }) : null;
                        },
                        onEachFeature: (feature, layer) => {
                            layer.on('click', (e) => handleMapClick(e));
                        }
                    });

                    // Añadir al mapa por defecto
                    geoLayers[config.id].addTo(map).setZIndex(config.zIndex);
                    
                    // Crear checkbox en panel izquierdo
                    createLayerCheckbox(config);
                    
                    // Alimentar buscador si es capa lote/sector/mzna
                    if(config.id === 'tg_sector') populateSector(data);

                } catch (error) {
                    console.error(`Error cargando ${config.id}:`, error);
                }
            }
        }

        function createLayerCheckbox(config) {
            const container = document.getElementById('layer-list');
            const div = document.createElement('div');
            div.className = 'layer-item';
            div.innerHTML = `
                <input type="checkbox" checked onchange="toggleLayer('${config.id}', this.checked)">
                <span>${config.name}</span>
            `;
            container.appendChild(div);
        }

        function toggleLayer(id, isVisible) {
            if (isVisible) map.addLayer(geoLayers[id]);
            else map.removeLayer(geoLayers[id]);
        }

        /**
         * LÓGICA DE SELECCIÓN POR CLIC (MÚLTIPLES CAPAS)
         */
        function handleMapClick(e) {
            L.DomEvent.stopPropagation(e);
            
            const results = [];
            const latlng = e.latlng;

            // Iterar sobre todas las capas visibles para encontrar qué hay bajo el clic
            Object.keys(geoLayers).forEach(key => {
                if (map.hasLayer(geoLayers[key])) {
                    geoLayers[key].eachLayer(layer => {
                        // Verificación geométrica manual simple para polígonos/puntos
                        if (layer.getBounds && layer.getBounds().contains(latlng)) {
                            results.push({ layerName: key, properties: layer.feature.properties, leafletLayer: layer });
                        } else if (layer.getLatLng && latlng.distanceTo(layer.getLatLng()) < 20) {
                            results.push({ layerName: key, properties: layer.feature.properties, leafletLayer: layer });
                        }
                    });
                }
            });

            if (results.length > 0) {
                showAttributeTable(results);
                highlightFeature(results[0].leafletLayer);
            }
        }

        function highlightFeature(layer) {
            if (selectedFeature) {
                const originalStyle = layersConfig.find(c => geoLayers[c.id].hasLayer(selectedFeature))?.style;
                if (originalStyle) selectedFeature.setStyle(originalStyle);
            }
            
            selectedFeature = layer;
            if (layer.setStyle) {
                layer.setStyle({
                    color: 'yellow',
                    weight: 4,
                    fillOpacity: 0.7
                });
                layer.bringToFront();
            }
        }

        /**
         * PANEL DE ATRIBUTOS
         */
        function showAttributeTable(results) {
            const panel = document.getElementById('info-panel');
            const content = document.getElementById('info-content');
            const title = document.getElementById('info-title');

            title.innerHTML = `Resultados Encontrados <span class="badge">${results.length} registros</span>`;
            
            let html = '';
            results.forEach((res, index) => {
                html += `<h4>Capa: ${res.layerName.toUpperCase()}</h4>`;
                html += `<div class="table-container"><table><thead><tr>`;
                
                // Cabeceras
                Object.keys(res.properties).forEach(key => html += `<th>${key}</th>`);
                html += `</tr></thead><tbody><tr>`;
                
                // Valores
                Object.values(res.properties).forEach(val => html += `<td>${val || '-'}</td>`);
                html += `</tr></tbody></table></div><hr>`;
            });

            content.innerHTML = html;
            panel.classList.add('active');
        }

        function closeInfo() {
            document.getElementById('info-panel').classList.remove('active');
            if (selectedFeature) {
                const config = layersConfig.find(c => geoLayers[c.id].hasLayer(selectedFeature));
                if(config) selectedFeature.setStyle(config.style);
            }
        }

        /**
         * BUSCADOR JERÁRQUICO
         */
        const selSector = document.getElementById('sel-sector');
        const selMzna = document.getElementById('sel-mzna');
        const selLote = document.getElementById('sel-lote');

        function populateSector(data) {
            const sectors = [...new Set(data.features.map(f => f.properties.cod_sector))].sort();
            sectors.forEach(s => {
                selSector.innerHTML += `<option value="${s}">${s}</option>`;
            });
        }

        selSector.addEventListener('change', () => {
            const val = selSector.value;
            selMzna.innerHTML = '<option value="">Seleccione Manzana...</option>';
            selMzna.disabled = !val;
            
            if (val) {
                const manzanas = [];
                geoLayers['tg_manzana'].eachLayer(l => {
                    if (l.feature.properties.cod_sector === val) {
                        manzanas.push(l.feature.properties.cod_mzna);
                    }
                });
                [...new Set(manzanas)].sort().forEach(m => selMzna.innerHTML += `<option value="${m}">${m}</option>`);
            }
        });

        selMzna.addEventListener('change', () => {
            const val = selMzna.value;
            selLote.innerHTML = '<option value="">Seleccione Lote...</option>';
            selLote.disabled = !val;

            if (val) {
                const lotes = [];
                geoLayers['tg_lote'].eachLayer(l => {
                    if (l.feature.properties.cod_mzna === val) {
                        lotes.push(l.feature.properties.cod_lote);
                    }
                });
                [...new Set(lotes)].sort().forEach(lot => selLote.innerHTML += `<option value="${lot}">${lot}</option>`);
            }
        });

        selLote.addEventListener('change', () => {
            const lotVal = selLote.value;
            const mznaVal = selMzna.value;

            geoLayers['tg_lote'].eachLayer(l => {
                if (l.feature.properties.cod_lote === lotVal && l.feature.properties.cod_mzna === mznaVal) {
                    map.fitBounds(l.getBounds());
                    highlightFeature(l);
                    showAttributeTable([{ layerName: 'tg_lote', properties: l.feature.properties, leafletLayer: l }]);
                }
            });
        });

        function resetFilters() {
            selSector.value = "";
            selMzna.innerHTML = '<option value="">Seleccione Manzana...</option>';
            selMzna.disabled = true;
            selLote.innerHTML = '<option value="">Seleccione Lote...</option>';
            selLote.disabled = true;
            closeInfo();
            map.setZoom(16);
        }

        // Iniciar
        loadLayers();

    </script>
</body>
</html>


