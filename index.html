<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Geovisor de Avance Catastral</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<style>
body { margin:0; font-family: Arial; }

header{
  background:#1e40af;
  color:white;
  padding:14px 20px;
  font-size:20px;
  font-weight:bold;
}

#map { height: calc(100vh - 65px); }

#panel {
  position:absolute;
  right:10px;
  top:80px;
  width:280px;
  background:white;
  border-radius:8px;
  padding:10px;
  box-shadow:0 2px 8px rgba(0,0,0,0.3);
  max-height:350px;
  overflow:auto;
  display:none;
  z-index:1000;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}

td{
  border:1px solid #ddd;
  padding:4px;
}
</style>
</head>
<body>

<header>Geovisor de Avance Catastral</header>
<div id="map"></div>
<div id="panel"></div>

<script>

var map = L.map('map',{
  maxZoom:22,
  minZoom:5
}).setView([-11.99,-77.05],15);

// BASES
var osm = L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
{maxZoom:22}
).addTo(map);

var sat = L.tileLayer(
'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
{maxZoom:22}
);

L.control.layers({"OSM":osm,"Satelital":sat}).addTo(map);

// BUSCADOR
L.Control.geocoder({
 defaultMarkGeocode:true
}).addTo(map);

// PANEL ATRIBUTOS
function mostrarAtributos(props){
 var html="<table>";
 for(var k in props){
   html+="<tr><td><b>"+k+"</b></td><td>"+props[k]+"</td></tr>";
 }
 html+="</table>";
 document.getElementById("panel").innerHTML=html;
 document.getElementById("panel").style.display="block";
}

// VARIABLES CAPAS
var sectorLayer, manzanaLayer, loteLayer, puertaLayer;

// CARGA DIFERIDA
function cargarSector(){
 if(sectorLayer) return;
 fetch('data/tg_sector.geojson')
 .then(r=>r.json())
 .then(data=>{
   sectorLayer=L.geoJSON(data,{
     style:{color:"#6b7280",weight:2,fill:false},
     onEachFeature:(f,l)=>l.on("click",()=>mostrarAtributos(f.properties))
   }).addTo(map);
 });
}

function cargarManzana(){
 if(manzanaLayer) return;
 fetch('data/tg_manzana.geojson')
 .then(r=>r.json())
 .then(data=>{
   manzanaLayer=L.geoJSON(data,{
     style:{color:"#2563eb",weight:2,fill:false},
     onEachFeature:(f,l)=>l.on("click",()=>mostrarAtributos(f.properties))
   });
 });
}

function cargarLote(){
 if(loteLayer) return;
 fetch('data/tg_lote.geojson')
 .then(r=>r.json())
 .then(data=>{
   loteLayer=L.geoJSON(data,{
     style:{color:"#16a34a",weight:1,fillOpacity:0.4},
     onEachFeature:(f,l)=>l.on("click",()=>mostrarAtributos(f.properties))
   });
 });
}

function cargarPuerta(){
 if(puertaLayer) return;
 fetch('data/tg_puerta.geojson')
 .then(r=>r.json())
 .then(data=>{
   puertaLayer=L.geoJSON(data,{
     pointToLayer:(f,latlng)=>
       L.circleMarker(latlng,{radius:2,color:"#000",fillOpacity:0.8}),
     onEachFeature:(f,l)=>l.on("click",()=>mostrarAtributos(f.properties))
   });
 });
}

// CONTROL POR ZOOM
map.on("zoomend",function(){
 var z=map.getZoom();

 if(z>=10) cargarSector();

 if(z>=14){
   cargarManzana();
   if(!map.hasLayer(manzanaLayer)) map.addLayer(manzanaLayer);
 } else if(manzanaLayer){
   map.removeLayer(manzanaLayer);
 }

 if(z>=17){
   cargarLote();
   if(!map.hasLayer(loteLayer)) map.addLayer(loteLayer);
 } else if(loteLayer){
   map.removeLayer(loteLayer);
 }

 if(z>=19){
   cargarPuerta();
   if(!map.hasLayer(puertaLayer)) map.addLayer(puertaLayer);
 } else if(puertaLayer){
   map.removeLayer(puertaLayer);
 }

});

// CARGA INICIAL
cargarSector();

</script>
</body>
</html>
