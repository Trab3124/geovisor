<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Geovisor Catastral</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { margin:0; font-family: Arial, sans-serif; }

header {
  background:#1f2937;
  color:white;
  padding:12px 20px;
  font-size:18px;
  font-weight:bold;
}

#map { height: calc(100vh - 60px); }

.control-box {
  background:white;
  padding:12px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
}

select, button {
  width:100%;
  margin-top:6px;
  padding:6px;
  border-radius:4px;
  border:1px solid #ccc;
}
</style>
</head>
<body>

<header>
  Geovisor Catastral Distrital
</header>

<div id="map"></div>

<script>

var map = L.map('map');

// Base map
var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors'
}).addTo(map);

var manzanaLayer;
var lotesLayer;

// Estilos
function styleManzana() {
  return { color:"#2563eb", weight:2, fill:false };
}

function styleLotes() {
  return { color:"#16a34a", weight:1, fillOpacity:0.4 };
}

// Cargar Manzanas
fetch('data/manzana.geojson')
.then(res => res.json())
.then(data => {

  manzanaLayer = L.geoJSON(data, {
    style: styleManzana,
    onEachFeature: function(feature, layer){
      layer.bindPopup(
        "<b>Sector:</b> "+feature.properties.cod_sector+
        "<br><b>Manzana:</b> "+feature.properties.cod_manzana
      );
    }
  }).addTo(map);

  map.fitBounds(manzanaLayer.getBounds());
});

// Cargar Lotes
fetch('data/lotes.geojson')
.then(res => res.json())
.then(data => {

  lotesLayer = L.geoJSON(data, {
    style: styleLotes,
    onEachFeature: function(feature, layer){
      layer.bindPopup(
        "<b>Lote:</b> "+feature.properties.cod_lote+
        "<br><b>Manzana:</b> "+feature.properties.cod_manzana
      );
    }
  }).addTo(map);

  crearFiltro(data);
});

// Control de capas
var baseMaps = {
  "OpenStreetMap": osm
};

var overlayMaps = {};

var controlCapas = L.control.layers(baseMaps, overlayMaps).addTo(map);

// Crear filtro dinámico
function crearFiltro(data){

  var manzanasUnicas = [];

  data.features.forEach(function(f){
    var mz = f.properties.cod_manzana;
    if(!manzanasUnicas.includes(mz)){
      manzanasUnicas.push(mz);
    }
  });

  manzanasUnicas.sort();

  var control = L.control({position:'topright'});

  control.onAdd = function(){
    var div = L.DomUtil.create('div','control-box');
    div.innerHTML = "<b>Filtrar por Manzana</b>";

    var select = document.createElement("select");
    select.innerHTML = "<option value=''>-- Todas --</option>";

    manzanasUnicas.forEach(function(mz){
      var option = document.createElement("option");
      option.value = mz;
      option.text = mz;
      select.appendChild(option);
    });

    select.onchange = function(){
      filtrarManzana(this.value);
    };

    div.appendChild(select);

    return div;
  };

  control.addTo(map);
}

function filtrarManzana(valor){

  lotesLayer.eachLayer(function(layer){

    if(valor === "" || layer.feature.properties.cod_manzana == valor){
      layer.addTo(map);
    } else {
      map.removeLayer(layer);
    }

  });

}

</script>
</body>
</html>
