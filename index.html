<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Geovisor Catastral</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* MANTENIENDO TU ESTILO ORIGINAL */
        body { margin:0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }

        .sidebar-left {
            position: absolute; top: 10px; left: 10px; width: 320px; z-index: 1000;
            display: flex; flex-direction: column; gap: 10px; max-height: 90vh;
        }
        .panel { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        
        /* ESTILO UNIFICADO PARA RESULTADOS Y CATEGORIAS */
        #results-panel, #floor-detail-panel { 
            display: none; flex-direction: column; overflow: hidden; 
            border-top: 5px solid #1e40af; /* Azul igual que Resultados */
        }
        
        .scroll-area { overflow-y: auto; flex-grow: 1; max-height: 300px; }

        /* Botones de Piso */
        .floor-selector { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; }
        .floor-btn { 
            padding: 5px; background: #f1f5f9; border: 1px solid #ccc; border-radius: 4px; 
            cursor: pointer; font-size: 10px; font-weight: bold;
        }
        .floor-btn.active { background: #1e40af; color: white; border-color: #1e40af; }

        /* Visor SVG */
        #floor-graphic { 
            width: 100%; height: 120px; background: #eee; border: 1px solid #ddd; 
            margin-bottom: 10px; display: flex; align-items: center; justify-content: center;
        }

        #search-panel { position: absolute; right: 10px; top: 10px; width: 250px; z-index: 1000; }
        h3 { margin: 0 0 10px 0; font-size: 14px; color: #1e40af; }
        
        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 10px; }
        td { border: 1px solid #ddd; padding: 4px; }
        .attr-key { font-weight: bold; background: #f9f9f9; width: 40%; }
        
        .close-btn { float: right; cursor: pointer; color: red; font-weight: bold; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="sidebar-left">
    <div class="panel">
        <h3>Capas</h3>
        <div id="layer-list"></div>
    </div>
    
    <div id="results-panel" class="panel">
        <span class="close-btn" onclick="this.parentElement.style.display='none'">×</span>
        <h3>Resultados</h3>
        <div id="results-content" class="scroll-area"></div>
    </div>

    <div id="floor-detail-panel" class="panel">
        <span class="close-btn" onclick="this.parentElement.style.display='none'">×</span>
        <h3>Categoría por Piso</h3>
        <div class="floor-selector" id="floor-btns-container"></div>
        <div class="scroll-area">
            <div id="floor-graphic">
                <svg id="svg-floor" width="100" height="100" viewBox="0 0 100 100"></svg>
            </div>
            <div id="floor-data-table"></div>
        </div>
    </div>
</div>

<div id="search-panel" class="panel">
    <h3>Buscador</h3>
    <select id="sel-sector" style="width:100%"><option value="">Sector</option></select><br><br>
    <select id="sel-mzna" style="width:100%" disabled><option value="">Manzana</option></select><br><br>
    <select id="sel-lote" style="width:100%" disabled><option value="">Lote</option></select>
</div>

<script>
    var map = L.map('map').setView([-12.046, -77.042], 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let geoLayers = {};
    let c2Data = []; // Para guardar tg_construccion_2 en memoria

    // Simulación de carga y filtrado basado en tu lógica
    async function loadData(sector) {
        // ... aquí irían tus fetches de tg_lote, tg_manzana, etc ...
        // Importante: tg_construccion_2 se carga pero NO se añade al mapa (L.geoJSON(data).addTo(map) NO se usa aquí)
        
        // Ejemplo de cómo manejar tg_construccion_2:
        /* const res = await fetch(`data/sector_${sector}/tg_construccion_2.geojson`);
           const data = await res.json();
           c2Data = data.features; 
        */
    }

    // FUNCIÓN PARA REFRESCAR LA PESTAÑA DE CATEGORIAS
    function updateFloorPanel(sector, mzna, lote) {
        const container = document.getElementById('floor-btns-container');
        const tableDiv = document.getElementById('floor-data-table');
        container.innerHTML = "";
        
        // Filtramos de los datos guardados en memoria
        const features = c2Data.filter(f => 
            f.properties.cod_sector == sector && 
            f.properties.cod_mzna == mzna && 
            f.properties.cod_lote == lote
        );

        if (features.length === 0) {
            document.getElementById('floor-detail-panel').style.display = 'none';
            return;
        }

        document.getElementById('floor-detail-panel').style.display = 'flex';
        const pisos = [...new Set(features.map(f => f.properties.piso || f.properties.cod_piso))].sort();

        pisos.forEach((p, i) => {
            const btn = document.createElement('button');
            btn.className = `floor-btn ${i === 0 ? 'active' : ''}`;
            btn.innerText = `PISO ${p}`;
            btn.onclick = () => {
                document.querySelectorAll('.floor-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderFloorInfo(features.filter(f => (f.properties.piso || f.properties.cod_piso) == p)[0]);
            };
            container.appendChild(btn);
        });

        renderFloorInfo(features.filter(f => (f.properties.piso || f.properties.cod_piso) == pisos[0])[0]);
    }

    function renderFloorInfo(feature) {
        const tableDiv = document.getElementById('floor-data-table');
        let html = "<table>";
        for (let key in feature.properties) {
            html += `<tr><td class="attr-key">${key}</td><td>${feature.properties[key] || '-'}</td></tr>`;
        }
        html += "</table>";
        tableDiv.innerHTML = html;
        drawSVG(feature);
    }

    function drawSVG(feature) {
        const svg = document.getElementById('svg-floor');
        svg.innerHTML = "";
        const coords = feature.geometry.coordinates[0];
        if (!coords) return;

        const lats = coords.map(c => c[1]), lngs = coords.map(c => c[0]);
        const minLat = Math.min(...lats), maxLat = Math.max(...lats);
        const minLng = Math.min(...lngs), maxLng = Math.max(...lngs);

        const pts = coords.map(c => {
            const x = ((c[0] - minLng) / (maxLng - minLng)) * 80 + 10;
            const y = 100 - (((c[1] - minLat) / (maxLat - minLat)) * 80 + 10);
            return `${x},${y}`;
        }).join(" ");

        const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        poly.setAttribute("points", pts);
        poly.setAttribute("fill", "#1e40af");
        poly.setAttribute("fill-opacity", "0.5");
        poly.setAttribute("stroke", "#1e40af");
        svg.appendChild(poly);
    }

    // Al filtrar el lote en tu buscador, debes llamar a:
    // updateFloorPanel(sSec.value, sMzn.value, sLot.value);
</script>
</body>
</html>
