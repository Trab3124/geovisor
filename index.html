<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Geovisor Catastral Pro - Ortofoto</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-textpath@1.2.3/leaflet.textpath.min.js"></script>

    <style>
        body { margin:0; font-family: Arial, sans-serif; background: #f1f5f9; overflow: hidden; }
        header {
            background: #1e40af; color: white; padding: 0 20px; font-size: 16px; font-weight: normal;
            display: flex; align-items: center; height: 40px; z-index: 1001; position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #map { height: calc(100vh - 40px); width: 100%; background: #e5e7eb; cursor: crosshair; }

        .sidebar-left {
            position: absolute; top: 50px; left: 10px; width: 340px; z-index: 1000;
            display: flex; flex-direction: column; gap: 10px; max-height: calc(100vh - 60px);
        }
        .panel { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        
        #results-panel { display: none; flex-direction: column; overflow: hidden; border-top: 5px solid #1e40af; max-height: 450px; }
        .scroll-area { overflow-y: auto; flex-grow: 1; margin-top: 10px; }

        #status-container {
            display: flex; align-items: center; gap: 8px; padding: 8px 12px; margin: 10px 0;
            border-radius: 6px; font-size: 11px; font-weight: bold; border: 1px solid transparent;
        }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .st-cargado { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .st-precampo { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .st-omision { background: #ffedd5; color: #9a3412; border-color: #fed7aa; }
        
        .edifica-highlight { font-weight: bold; padding: 2px 6px; border-radius: 4px; color: white; font-size: 10px; }

        #search-panel { position: absolute; right: 10px; top: 50px; width: 280px; z-index: 1000; }
        h3 { margin: 0 0 10px 0; font-size: 13px; color: #1e40af; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 12px; border: 1px solid #cbd5e1; }
        td { border: 1px solid #e2e8f0; padding: 6px; }
        .attr-key { font-weight: bold; background: #f8fafc; color: #475569; width: 35%; }
        
        .fid-link { color: #2563eb; text-decoration: underline; cursor: pointer; font-weight: bold; }
        .order-badge { background: #1e40af; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; }

        select { width: 100%; padding: 7px; border-radius: 4px; border: 1px solid #cbd5e1; font-size: 12px; margin-top: 4px; }
        label { font-size: 11px; font-weight: bold; color: #64748b; }
        .btn-reset { width: 100%; padding: 8px; background: #64748b; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 8px; font-weight: bold; }
        
        .layer-row { display: flex; align-items: center; font-size: 12px; margin-bottom: 5px; }
        .close-btn { color: #ef4444; cursor: pointer; font-size: 18px; font-weight: bold; }
        
        .label-sector { font-size: 18px; font-weight: bold; color: #1e40af; text-shadow: 2px 2px 0 #fff200, -2px -2px 0 #fff200, 2px -2px 0 #fff200, -2px 2px 0 #fff200; white-space: nowrap; }
        .label-mzna { font-size: 12px; font-weight: bold; color: #2563eb; text-shadow: 1.5px 1.5px 0px #fff; }
        .label-lote { font-size: 10px; color: #16a34a; text-shadow: 1px 1px 0px #fff; }
        .leaflet-interactive { cursor: pointer; }
    </style>
</head>
<body>

<header>Geovisor de Avance Catastral</header>
<div id="map"></div>

<div class="sidebar-left">
    <div class="panel">
        <h3>Capas Catastrales</h3>
        <div id="layer-list"></div>
    </div>
    <div id="results-panel" class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0">Resultados</h3>
            <select id="filter-layer-results" onchange="updateResultsUI()" style="width:130px; margin:0">
                <option value="ALL">Ver Todas</option>
                <option value="TG_LOTE">Lotes</option>
                <option value="TG_EDIFICA">Edificas</option>
                <option value="TG_CONSTRUCCION">Construcciones</option>
                <option value="TG_PUERTA">Puertas</option>
            </select>
            <span class="close-btn" onclick="closeResults()">&times;</span>
        </div>
        <div id="status-box"></div> 
        <div id="results-content" class="scroll-area"></div>
    </div>
</div>

<div id="search-panel" class="panel">
    <h3>Búsqueda Jerárquica</h3>
    <div style="margin-bottom:8px">
        <label>Sector</label>
        <select id="sel-sector"><option value="">Seleccione...</option></select>
    </div>
    <div style="margin-bottom:8px">
        <label>Manzana</label>
        <select id="sel-mzna" disabled><option value="">Seleccione...</option></select>
    </div>
    <div style="margin-bottom:8px">
        <label>Lote</label>
        <select id="sel-lote" disabled><option value="">Seleccione...</option></select>
    </div>
    <button class="btn-reset" onclick="resetFilters()">Limpiar Filtros</button>
</div>

<script>
    var map = L.map('map', { zoomControl: false, maxZoom: 24 }).setView([-12.046, -77.042], 18);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    var sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 24, maxNativeZoom: 19 }).addTo(map);
    var ortoimagen = L.tileLayer('./ortofoto/{z}/{x}/{y}.jpg', { minZoom: 17, maxZoom: 24, maxNativeZoom: 20 }).addTo(map);
    L.control.layers({ "Satélite": sat, "Ortofoto": ortoimagen }, null, {position: 'topright'}).addTo(map);

    const BASE_PATH = './data';
    const sectorLayerKey = 'tg_sector';
    const viaLayerKey = 'tg_eje_via';
    const CSV_URL = 'https://raw.githubusercontent.com/Trab3124/geovisor/refs/heads/main/estados_manzana.csv';

    const styles = {
        'tg_sector': { color: "#1e40af", weight: 3, fill: false, opacity: 1, interactive: true },
        'tg_eje_via': { color: "#334155", weight: 2, opacity: 0.8, interactive: false },
        'tg_manzana': { color: "#f97316", weight: 2, fill: false, opacity: 1, interactive: true },
        'tg_lote': { color: "#16a34a", weight: 1.5, fillOpacity: 0.2, opacity: 1, interactive: true },
        'tg_edifica': { color: "#d97706", weight: 1, fillOpacity: 0.4, opacity: 1, interactive: false },
        'tg_construccion': { color: "#dc2626", weight: 0.8, fillOpacity: 0.3, opacity: 1, interactive: false },
        'tg_puerta': { radius: 2.5, fillColor: "#000", color: "#fff", weight: 0.5, fillOpacity: 1, opacity: 1, interactive: false }
    };

    let geoLayers = {};
    let excelData = []; 
    let currentResultsData = [];
    let highlightLayer = L.layerGroup().addTo(map);
    let labelLayer = L.layerGroup().addTo(map);
    let sectorLabels = L.layerGroup().addTo(map);
    let viaLabels = L.layerGroup().addTo(map);

    const sSec = document.getElementById('sel-sector'), sMzn = document.getElementById('sel-mzna'), sLot = document.getElementById('sel-lote');

    async function fetchExcelStatus() {
        try {
            const res = await fetch(CSV_URL);
            const text = await res.text();
            const rows = text.split('\n').slice(1);
            excelData = rows.map(row => {
                const cols = row.split(',');
                return { sector: cols[0]?.trim(), mzna: cols[1]?.trim(), estado: cols[2]?.trim() };
            });
        } catch (e) {}
    }

    async function init() {
        await fetchExcelStatus();

        // Cargar Ejes de Vía con Etiquetas Paralelas
        try {
            const resV = await fetch(`${BASE_PATH}/${viaLayerKey}.geojson`);
            const dataV = await resV.json();
            geoLayers[viaLayerKey] = L.geoJSON(dataV, { 
                style: styles[viaLayerKey],
                onEachFeature: (f, l) => {
                    const txt = `${f.properties.cod_via || ''} ${f.properties.nom_via || ''}`.trim();
                    if(txt) {
                        l.setText(txt, { repeat: true, offset: -8, attributes: { 'font-weight': 'bold', 'font-size': '13', 'fill': '#000' } });
                    }
                }
            }).addTo(map);
            addLayerCheckbox(viaLayerKey);
        } catch(e) {}

        try {
            const res = await fetch(`${BASE_PATH}/${sectorLayerKey}.geojson`);
            const data = await res.json();
            geoLayers[sectorLayerKey] = L.geoJSON(data, { 
                style: styles[sectorLayerKey],
                onEachFeature: (f, l) => {
                    L.marker(l.getBounds().getCenter(), { icon: L.divIcon({ className: 'label-sector', html: f.properties.cod_sector }), interactive: false }).addTo(sectorLabels);
                }
            }).addTo(map);
            addLayerCheckbox(sectorLayerKey);
            const sectoresList = populateSectors(data);
            geoLayers['tg_manzana'] = L.featureGroup().addTo(map);
            addLayerCheckbox('tg_manzana');
            for (let sId of sectoresList) {
                const folder = `${BASE_PATH}/sector_${sId.padStart(2, '0')}`;
                fetch(`${folder}/tg_manzana.geojson`).then(r => r.json()).then(mznData => {
                    L.geoJSON(mznData, { style: styles['tg_manzana'], onEachFeature: (f, l) => {
                        l.on('click', (e) => { L.DomEvent.stopPropagation(e); autoFilterByManzana(f.properties); });
                    }}).addTo(geoLayers['tg_manzana']);
                }).catch(e => {});
            }
            map.fitBounds(geoLayers[sectorLayerKey].getBounds());
        } catch(e) {}
        map.on('zoomend', handleLabelsVisibility);
    }

    function handleLabelsVisibility() {
        const zoom = map.getZoom();
        if (zoom > 17) { if(map.hasLayer(sectorLabels)) map.removeLayer(sectorLabels); } 
        else { if(document.getElementById('chk-tg_sector')?.checked) map.addLayer(sectorLabels); }
        
        if (zoom < 17 && geoLayers[viaLayerKey]) { map.removeLayer(geoLayers[viaLayerKey]); }
        else if (document.getElementById(`chk-${viaLayerKey}`)?.checked) { map.addLayer(geoLayers[viaLayerKey]); }
        
        refreshLabels();
    }

    async function loadSectorDetail(sectorId) {
        const keysToClear = ['tg_lote', 'tg_edifica', 'tg_construccion', 'tg_puerta'];
        keysToClear.forEach(key => { if (geoLayers[key]) map.removeLayer(geoLayers[key]); });
        const folder = `${BASE_PATH}/sector_${sectorId.padStart(2, '0')}`;
        for (let key of keysToClear) {
            try {
                const res = await fetch(`${folder}/${key}.geojson`);
                if (!res.ok) continue;
                const data = await res.json();
                geoLayers[key] = L.geoJSON(data, {
                    style: styles[key],
                    pointToLayer: (f, latlng) => key === 'tg_puerta' ? L.circleMarker(latlng, styles[key]) : null,
                    onEachFeature: (f, l) => { if (key === 'tg_lote') l.on('click', (e) => { L.DomEvent.stopPropagation(e); autoFilterByLote(f.properties); }); }
                }).addTo(map);
                if (!document.getElementById(`chk-${key}`)) addLayerCheckbox(key);
            } catch(e) {}
        }
    }

    function autoFilterByManzana(props) {
        sSec.value = props.cod_sector;
        loadSectorDetail(props.cod_sector).then(() => { updateManzanas(() => { sMzn.value = props.cod_mzna; updateLotes(); executeFinalFilter(); }); });
    }

    function autoFilterByLote(props) {
        if (sSec.value !== props.cod_sector) { sSec.value = props.cod_sector; loadSectorDetail(props.cod_sector).then(() => finishAutoFilter(props)); } 
        else finishAutoFilter(props);
    }

    function finishAutoFilter(props) { updateManzanas(() => { sMzn.value = props.cod_mzna; updateLotes(() => { sLot.value = props.cod_lote; executeFinalFilter(); }); }); }

    function executeFinalFilter() {
        const sec = sSec.value, mzn = sMzn.value, lot = sLot.value;
        if(!mzn) return;
        currentResultsData = [];
        let zoomBounds = L.latLngBounds();
        const allKeys = [sectorLayerKey, 'tg_lote', 'tg_edifica', 'tg_construccion', 'tg_puerta'];
        allKeys.forEach(id => {
            if (!geoLayers[id]) return;
            geoLayers[id].eachLayer(l => {
                const p = l.feature.properties;
                const isExactLote = (p.cod_sector == sec && p.cod_mzna == mzn && p.cod_lote == lot);
                const isMznMatch = (p.cod_sector == sec && p.cod_mzna == mzn);
                if (id === 'tg_lote') {
                    if (isMznMatch) {
                        l.setStyle({ opacity: 1, fillOpacity: 0 }); 
                        // REHABILITAR INTERACTIVIDAD PARA CLIC MANUAL EN LOTE TRAS FILTRO DE MANZANA
                        if(l.getElement()) l.getElement().style.pointerEvents = 'auto';
                        if (isExactLote || !lot) {
                            currentResultsData.push({ layer: id.toUpperCase(), props: p, obj: l });
                            zoomBounds.extend(l.getBounds());
                        }
                    } else {
                        l.setStyle({ opacity: 0, fillOpacity: 0 });
                        if(l.getElement()) l.getElement().style.pointerEvents = 'none';
                    }
                } else if (id !== sectorLayerKey) {
                    if (isExactLote) {
                        l.setStyle({ opacity: 1, fillOpacity: 0 }); 
                        currentResultsData.push({ layer: id.toUpperCase(), props: p, obj: l });
                        if (l.getBounds) zoomBounds.extend(l.getBounds()); else zoomBounds.extend(l.getLatLng());
                    } else l.setStyle({ opacity: 0, fillOpacity: 0 });
                }
            });
        });
        if (zoomBounds.isValid()) {
            map.fitBounds(zoomBounds, { padding: [40, 40], maxZoom: 21 });
            updateResultsUI();
            highlightBorders(currentResultsData.map(d => d.obj));
            refreshLabels(); 
        }
    }

    function refreshLabels() {
        labelLayer.clearLayers();
        const zoom = map.getZoom();
        if (zoom < 16 || !sMzn.value) return;
        geoLayers['tg_manzana'].eachLayer(group => {
            group.eachLayer(l => { if (l.feature.properties.cod_mzna === sMzn.value && l.feature.properties.cod_sector === sSec.value) L.marker(l.getBounds().getCenter(), { icon: L.divIcon({ className: 'label-mzna', html: `MZ ${l.feature.properties.cod_mzna}` }), interactive: false }).addTo(labelLayer); });
        });
        if (zoom >= 19 && geoLayers['tg_lote']) {
            geoLayers['tg_lote'].eachLayer(l => { if (l.feature.properties.cod_mzna === sMzn.value && l.feature.properties.cod_sector === sSec.value) L.marker(l.getBounds().getCenter(), { icon: L.divIcon({ className: 'label-lote', html: l.feature.properties.cod_lote }), interactive: false }).addTo(labelLayer); });
        }
    }

    function populateSectors(data) {
        const items = [...new Set(data.features.map(f => f.properties.cod_sector))].sort();
        items.forEach(i => sSec.innerHTML += `<option value="${i}">${i}</option>`);
        return items;
    }

    function updateManzanas(callback) {
        sMzn.innerHTML = '<option value="">Seleccione...</option>'; sLot.innerHTML = '<option value="">Seleccione...</option>';
        sMzn.disabled = !sSec.value;
        if(sSec.value && geoLayers['tg_manzana']) {
            let list = [];
            geoLayers['tg_manzana'].eachLayer(group => { group.eachLayer(l => { if(l.feature.properties.cod_sector == sSec.value) list.push(l.feature.properties.cod_mzna); }); });
            [...new Set(list)].sort().forEach(m => sMzn.innerHTML += `<option value="${m}">${m}</option>`);
        }
        if(callback) callback();
    }

    function updateLotes(callback) {
        sLot.innerHTML = '<option value="">Seleccione...</option>'; sLot.disabled = !sMzn.value;
        if(sMzn.value && geoLayers['tg_lote']) {
            let list = [];
            geoLayers['tg_lote'].eachLayer(l => { if(l.feature.properties.cod_sector == sSec.value && l.feature.properties.cod_mzna == sMzn.value) list.push(l.feature.properties.cod_lote); });
            [...new Set(list)].sort().forEach(lo => sLot.innerHTML += `<option value="${lo}">${lo}</option>`);
        }
        if(callback) callback();
    }

    sSec.onchange = async () => { if (sSec.value) { await loadSectorDetail(sSec.value); updateManzanas(); } else resetFilters(); };
    sMzn.onchange = () => { updateLotes(); executeFinalFilter(); };
    sLot.onchange = () => executeFinalFilter();

    function highlightBorders(objs) {
        highlightLayer.clearLayers();
        objs.forEach(o => highlightLayer.addLayer(L.geoJSON(o.feature, { style: { color: '#00FFFF', weight: 4, fillOpacity: 0, opacity: 1 }, pointToLayer: (f, latlng) => L.circleMarker(latlng, {radius:8}) })));
    }

    function resetFilters() { location.reload(); }

    function addLayerCheckbox(id) {
        if(document.getElementById(`chk-${id}`)) return;
        const list = document.getElementById('layer-list');
        const labels = {tg_sector:'Sectores', tg_eje_via:'Ejes de Vía', tg_manzana:'Manzanas', tg_lote:'Lotes', tg_edifica:'Edificas', tg_construccion:'Construcciones', tg_puerta:'Puertas'};
        const div = document.createElement('div');
        div.className = 'layer-row';
        div.innerHTML = `<input type="checkbox" checked id="chk-${id}"> <label for="chk-${id}">${labels[id]}</label>`;
        div.querySelector('input').onchange = (e) => {
            if(e.target.checked) { if(id === sectorLayerKey) handleLabelsVisibility(); else map.addLayer(geoLayers[id]); }
            else { if(id === sectorLayerKey) map.removeLayer(sectorLabels); else map.removeLayer(geoLayers[id]); }
            refreshLabels();
        };
        list.appendChild(div);
    }

    function zoomToFid(layerId, fidValue) {
        if(!geoLayers[layerId]) return;
        geoLayers[layerId].eachLayer(l => {
            if (l.feature.properties.fid == fidValue) {
                if (l.getBounds) map.fitBounds(l.getBounds(), { maxZoom: 22 });
                else map.setView(l.getLatLng(), 22);
                highlightBorders([l]);
            }
        });
    }

    function updateResultsUI() {
        const filter = document.getElementById('filter-layer-results').value;
        const content = document.getElementById('results-content');
        const statusBox = document.getElementById('status-box');
        const panel = document.getElementById('results-panel');
        const sec = sSec.value;
        const mzn = sMzn.value;
        const dataEstado = excelData.find(d => d.sector == sec && d.mzna == mzn);
        statusBox.innerHTML = ""; 
        if (dataEstado) {
            let config = { cls: 'st-omision', dot: '#f97316' };
            if (dataEstado.estado === 'Cargado') config = { cls: 'st-cargado', dot: '#16a34a' };
            if (dataEstado.estado === 'PreCampo') config = { cls: 'st-precampo', dot: '#dc2626' };
            statusBox.innerHTML = `<div id="status-container" class="${config.cls}"><div class="status-dot" style="background:${config.dot}"></div>ESTADO MZ: ${dataEstado.estado.toUpperCase()}</div>`;
        }
        let data = filter === 'ALL' ? [...currentResultsData] : currentResultsData.filter(d => d.layer === filter);
        const edificaColors = ["#2563eb", "#7c3aed", "#db2777", "#059669", "#d97706", "#475569"];
        data.sort((a, b) => {
            const layerOrder = { 'TG_LOTE': 1, 'TG_EDIFICA': 2, 'TG_CONSTRUCCION': 3, 'TG_PUERTA': 4 };
            if (layerOrder[a.layer] !== layerOrder[b.layer]) return layerOrder[a.layer] - layerOrder[b.layer];
            const edifA = parseInt(a.props.cod_edific) || 0;
            const edifB = parseInt(b.props.cod_edific) || 0;
            if (edifA !== edifB) return edifA - edifB;
            const valA = parseInt(a.props.piso || a.props.orden) || 0;
            const valB = parseInt(b.props.piso || b.props.orden) || 0;
            return valA - valB;
        });
        let html = "";
        data.forEach((item) => {
            let badge = '';
            if (item.layer === 'TG_PUERTA' && item.props.orden) badge = `<span class="order-badge">Orden ${item.props.orden}</span>`;
            else if (item.layer === 'TG_CONSTRUCCION' && item.props.piso) badge = `<span class="order-badge" style="background:#dc2626">Piso ${item.props.piso}</span>`;
            html += `<div style="background:#f1f5f9; padding:5px; font-weight:bold; font-size:10px; border-left:4px solid #1e40af; display:flex; justify-content:space-between; align-items:center;"><span>CAPA: ${item.layer}</span>${badge}</div>`;
            html += `<table>`;
            for (let key in item.props) {
                let val = item.props[key];
                if (key.toLowerCase() === 'cod_edific' && val) {
                    const idx = parseInt(val) % edificaColors.length;
                    const color = edificaColors[idx];
                    val = `<span class="edifica-highlight" style="background:${color}">${val}</span>`;
                }
                if (key.toLowerCase() === 'fid') val = `<span class="fid-link" onclick="zoomToFid('${item.layer.toLowerCase()}', '${val}')">${val}</span>`;
                html += `<tr><td class="attr-key">${key}</td><td>${val || '-'}</td></tr>`;
            }
            html += `</table>`;
        });
        content.innerHTML = html || "<p style='text-align:center; font-size:11px; color:gray;'>No hay datos.</p>";
        panel.style.display = 'flex';
    }

    function closeResults() { document.getElementById('results-panel').style.display = 'none'; highlightLayer.clearLayers(); }

    init();
</script>
</body>
</html>
