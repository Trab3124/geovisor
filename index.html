<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Geovisor Catastral - Ortofoto Optimizada</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin:0; font-family: Arial, sans-serif; background: #f1f5f9; overflow: hidden; }
        header {
            background: #1e40af; color: white; padding: 0 20px; font-size: 18px; font-weight: bold;
            display: flex; align-items: center; height: 55px; z-index: 1001; position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #map { height: calc(100vh - 55px); width: 100%; background: #e5e7eb; cursor: crosshair; }

        .sidebar-left {
            position: absolute; top: 65px; left: 10px; width: 340px; z-index: 1000;
            display: flex; flex-direction: column; gap: 10px; max-height: calc(100vh - 80px);
        }
        .panel { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        
        #results-panel { display: none; flex-direction: column; overflow: hidden; border-top: 5px solid #1e40af; max-height: 450px; }
        .scroll-area { overflow-y: auto; flex-grow: 1; margin-top: 10px; }

        #search-panel { position: absolute; right: 10px; top: 65px; width: 280px; z-index: 1000; }

        h3 { margin: 0 0 10px 0; font-size: 13px; color: #1e40af; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .results-header-flex { display: flex; align-items: center; justify-content: space-between; gap:5px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 12px; border: 1px solid #cbd5e1; }
        td { border: 1px solid #e2e8f0; padding: 6px; }
        .attr-key { font-weight: bold; background: #f8fafc; color: #475569; width: 35%; }
        
        .label-mzna {
            font-size: 12px; font-weight: bold; color: #2563eb;
            text-shadow: 1px 1px 0px #fff, -1px -1px 0px #fff, 1px -1px 0px #fff, -1px 1px 0px #fff;
            background: none; border: none; box-shadow: none;
        }
        .label-lote {
            font-size: 10px; color: #16a34a;
            text-shadow: 1px 1px 0px #fff, -1px -1px 0px #fff, 1px -1px 0px #fff, -1px 1px 0px #fff;
            background: none; border: none; box-shadow: none;
        }
    </style>
</head>
<body>

<header>Geovisor de Avance Catastral</header>
<div id="map"></div>

<div class="sidebar-left">
    <div class="panel">
        <h3>Capas Catastrales</h3>
        <div id="layer-list"></div>
    </div>
    <div id="results-panel" class="panel">
        <div class="results-header-flex">
            <h3 style="margin:0">Resultados</h3>
            <span style="color:red; cursor:pointer; font-weight:bold;" onclick="resetFilters()">[X]</span>
        </div>
        <div id="results-content" class="scroll-area"></div>
    </div>
</div>

<div id="search-panel" class="panel">
    <h3>Búsqueda Jerárquica</h3>
    <div style="margin-bottom:8px">
        <label>Sector</label>
        <select id="sel-sector"><option value="">Seleccione...</option></select>
    </div>
    <div style="margin-bottom:8px">
        <label>Manzana</label>
        <select id="sel-mzna" disabled><option value="">Seleccione...</option></select>
    </div>
    <div style="margin-bottom:8px">
        <label>Lote</label>
        <select id="sel-lote" disabled><option value="">Seleccione...</option></select>
    </div>
    <button style="width:100%; padding:8px; margin-top:5px; cursor:pointer;" onclick="resetFilters()">Limpiar</button>
</div>

<script>
    // 1. CONFIGURACIÓN DEL MAPA (Zoom hasta 24)
    var map = L.map('map', { zoomControl: false, maxZoom: 24 }).setView([-12.046, -77.042], 16);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // 2. CAPAS BASE
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 24, maxNativeZoom: 19 });
    var sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 24, maxNativeZoom: 19 });
    
    // ORTOFOTO CON OVERZOOMING (Evita el fondo blanco)
    var ortofoto = L.tileLayer('ortofoto/{z}/{x}/{y}.jpg', {
        minZoom: 12,
        maxZoom: 24,           // Permite que el visor llegue a 24
        maxNativeZoom: 18,     // <--- AJUSTA ESTO: Si exportaste hasta 18 en QGIS, deja 18. Si fue 20, pon 20.
        attribution: 'Ortofoto Propia'
    }).addTo(map);

    var baseMaps = {
        "Mi Ortofoto": ortofoto,
        "Satélite": sat,
        "Callejero": osm
    };
    L.control.layers(baseMaps, null, {position: 'topright', collapsed: false}).addTo(map);

    // 3. CAPAS VECTORIALES
    const layerKeys = ['tg_sector', 'tg_manzana', 'tg_lote', 'tg_edifica', 'tg_construccion', 'tg_puerta'];
    const styles = {
        'tg_sector': { color: "#475569", weight: 3, fill: false, interactive: false },
        'tg_manzana': { color: "#2563eb", weight: 2, fill: false, interactive: false },
        'tg_lote': { color: "#16a34a", weight: 1.5, fillOpacity: 0.1, interactive: true },
        'tg_edifica': { color: "#d97706", weight: 1, fillOpacity: 0.3, interactive: false },
        'tg_construccion': { color: "#dc2626", weight: 0.8, fillOpacity: 0.2, interactive: false },
        'tg_puerta': { radius: 4, fillColor: "#000", color: "#fff", weight: 1, fillOpacity: 1, interactive: false }
    };

    let geoLayers = {};
    let currentResultsData = [];
    let highlightLayer = L.layerGroup().addTo(map);
    let labelLayer = L.layerGroup().addTo(map);

    async function init() {
        for (let id of layerKeys) {
            try {
                const res = await fetch(`data/${id}.geojson`);
                const data = await res.json();
                geoLayers[id] = L.geoJSON(data, {
                    style: styles[id],
                    pointToLayer: (f, latlng) => id === 'tg_puerta' ? L.circleMarker(latlng, styles[id]) : null,
                    onEachFeature: (f, l) => {
                        if (id === 'tg_lote') {
                            l.on('click', (e) => {
                                L.DomEvent.stopPropagation(e);
                                autoFilterByLote(f.properties);
                            });
                        }
                    }
                }).addTo(map);
                addLayerCheckbox(id);
                if(id === 'tg_sector') populateSectors(data);
            } catch(e) { console.warn("Error cargando " + id); }
        }
        map.on('zoomend', refreshLabels);
    }

    function refreshLabels() {
        labelLayer.clearLayers();
        const zoom = map.getZoom();
        const sec = sSec.value, mzn = sMzn.value;
        if (!mzn || zoom < 17) return;

        geoLayers['tg_manzana'].eachLayer(l => {
            if (l.feature.properties.cod_mzna === mzn && l.feature.properties.cod_sector === sec) {
                L.marker(l.getBounds().getCenter(), {
                    icon: L.divIcon({ className: 'label-mzna', html: `MZ ${l.feature.properties.cod_mzna}` }),
                    interactive: false
                }).addTo(labelLayer);
            }
        });

        if (zoom >= 19) {
            geoLayers['tg_lote'].eachLayer(l => {
                const p = l.feature.properties;
                if (p.cod_mzna === mzn && p.cod_sector === sec) {
                    L.marker(l.getBounds().getCenter(), {
                        icon: L.divIcon({ className: 'label-lote', html: p.cod_lote }),
                        interactive: false
                    }).addTo(labelLayer);
                }
            });
        }
    }

    function autoFilterByLote(props) {
        sSec.value = props.cod_sector;
        updateManzanas(() => {
            sMzn.value = props.cod_mzna;
            updateLotes(() => {
                sLot.value = props.cod_lote;
                executeFinalFilter();
            });
        });
    }

    function executeFinalFilter() {
        const sec = sSec.value, mzn = sMzn.value, lot = sLot.value;
        if(!lot) return;
        currentResultsData = [];
        let zoomBounds = L.latLngBounds();

        for (let id in geoLayers) {
            geoLayers[id].eachLayer(l => {
                const p = l.feature.properties;
                const isExactLote = (p.cod_sector == sec && p.cod_mzna == mzn && p.cod_lote == lot);
                const isMznaMatch = (p.cod_sector == sec && p.cod_mzna == mzn);

                if (id === 'tg_lote') {
                    if (isMznaMatch) {
                        l.setStyle({ opacity: 1, fillOpacity: 0.1 });
                        if (isExactLote) {
                            currentResultsData.push({ layer: id.toUpperCase(), props: p, obj: l });
                            zoomBounds.extend(l.getBounds());
                        }
                    } else { l.setStyle({ opacity: 0, fillOpacity: 0 }); }
                } else {
                    if (isExactLote) {
                        l.setStyle({ opacity: 1, fillOpacity: styles[id].fillOpacity });
                        currentResultsData.push({ layer: id.toUpperCase(), props: p, obj: l });
                        if (l.getBounds) zoomBounds.extend(l.getBounds());
                        else zoomBounds.extend(l.getLatLng());
                    } else { l.setStyle({ opacity: 0, fillOpacity: 0 }); }
                }
            });
        }
        if (currentResultsData.length > 0) {
            // Ajustamos el zoom de consulta para que no sobrepase el nivel de la foto
            map.fitBounds(zoomBounds, { padding: [40, 40], maxZoom: 20 });
            updateResultsUI();
            highlightBorders(currentResultsData.map(d => d.obj));
            refreshLabels();
        }
    }

    function addLayerCheckbox(id) {
        const list = document.getElementById('layer-list');
        const labels = {tg_sector:'Sectores', tg_manzana:'Manzanas', tg_lote:'Lotes', tg_edifica:'Edificaciones', tg_construccion:'Construcciones', tg_puerta:'Puertas'};
        const div = document.createElement('div');
        div.style.fontSize = "12px";
        div.innerHTML = `<input type="checkbox" checked id="chk-${id}"> ${labels[id]}`;
        div.querySelector('input').onchange = (e) => {
            if(e.target.checked) map.addLayer(geoLayers[id]);
            else map.removeLayer(geoLayers[id]);
        };
        list.appendChild(div);
    }

    function updateResultsUI() {
        const content = document.getElementById('results-content');
        const panel = document.getElementById('results-panel');
        let html = "";
        currentResultsData.forEach((item) => {
            html += `<div style="background:#eee; padding:3px; font-weight:bold; font-size:10px;">${item.layer}</div>`;
            html += `<table>`;
            for (let key in item.props) {
                html += `<tr><td class="attr-key">${key}</td><td>${item.props[key] || '-'}</td></tr>`;
            }
            html += `</table>`;
        });
        content.innerHTML = html;
        panel.style.display = 'flex';
    }

    function highlightBorders(objs) {
        highlightLayer.clearLayers();
        objs.forEach(o => {
            highlightLayer.addLayer(L.geoJSON(o.feature, { style: { color: 'yellow', weight: 4, fillOpacity: 0 } }));
        });
    }

    const sSec = document.getElementById('sel-sector'), sMzn = document.getElementById('sel-mzna'), sLot = document.getElementById('sel-lote');

    function populateSectors(data) {
        const items = [...new Set(data.features.map(f => f.properties.cod_sector))].sort();
        items.forEach(i => sSec.innerHTML += `<option value="${i}">${i}</option>`);
    }

    function updateManzanas(callback) {
        sMzn.innerHTML = '<option value="">Seleccione...</option>';
        sMzn.disabled = !sSec.value;
        if(sSec.value) {
            let list = [];
            geoLayers['tg_manzana'].eachLayer(l => { if(l.feature.properties.cod_sector == sSec.value) list.push(l.feature.properties.cod_mzna); });
            [...new Set(list)].sort().forEach(m => sMzn.innerHTML += `<option value="${m}">${m}</option>`);
        }
        if(callback) callback();
    }

    function updateLotes(callback) {
        sLot.innerHTML = '<option value="">Seleccione...</option>';
        sLot.disabled = !sMzn.value;
        if(sMzn.value) {
            let list = [];
            geoLayers['tg_lote'].eachLayer(l => { if(l.feature.properties.cod_sector == sSec.value && l.feature.properties.cod_mzna == sMzn.value) list.push(l.feature.properties.cod_lote); });
            [...new Set(list)].sort().forEach(lo => sLot.innerHTML += `<option value="${lo}">${lo}</option>`);
        }
        if(callback) callback();
    }

    sSec.onchange = () => updateManzanas();
    sMzn.onchange = () => { updateLotes(); executeFinalFilter(); };
    sLot.onchange = () => executeFinalFilter();

    function resetFilters() {
        sSec.value = ""; sMzn.disabled = true; sLot.disabled = true;
        document.getElementById('results-panel').style.display = 'none';
        highlightLayer.clearLayers();
        labelLayer.clearLayers();
        for (let id in geoLayers) { geoLayers[id].eachLayer(l => l.setStyle(styles[id])); }
        map.setView([-12.046, -77.042], 16);
    }

    init();
</script>
</body>
</html>
