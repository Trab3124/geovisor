<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Geovisor Catastral Pro - Categorías</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin:0; font-family: Arial, sans-serif; background: #f1f5f9; overflow: hidden; }
        header {
            background: #1e40af; color: white; padding: 0 20px; font-size: 16px; font-weight: normal;
            display: flex; align-items: center; height: 40px; z-index: 1001; position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #map { height: calc(100vh - 40px); width: 100%; background: #e5e7eb; cursor: crosshair; }

        .sidebar-left {
            position: absolute; top: 50px; left: 10px; width: 340px; z-index: 1000;
            display: flex; flex-direction: column; gap: 10px; max-height: calc(100vh - 60px);
        }
        .panel { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-top: 5px solid #1e40af; }
        
        #results-panel, #floor-detail-panel { display: none; flex-direction: column; overflow: hidden; max-height: 400px; }
        .scroll-area { overflow-y: auto; flex-grow: 1; margin-top: 10px; }

        /* Selector de Pisos */
        .floor-selector { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0; }
        .floor-btn { 
            padding: 5px 10px; background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 4px; 
            cursor: pointer; font-size: 10px; font-weight: bold; color: #1e40af;
        }
        .floor-btn.active { background: #1e40af; color: white; border-color: #1e40af; }

        /* Visor de Polígono en Pestaña */
        #floor-graphic-container { 
            width: 100%; height: 150px; background: #0f172a; border-radius: 6px; 
            margin-bottom: 12px; display: flex; align-items: center; justify-content: center;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        #search-panel { position: absolute; right: 10px; top: 50px; width: 280px; z-index: 1000; border-top: 5px solid #1e40af; }
        h3 { margin: 0 0 10px 0; font-size: 12px; color: #1e40af; text-transform: uppercase; letter-spacing: 0.5px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 10px; border: 1px solid #cbd5e1; }
        td { border: 1px solid #e2e8f0; padding: 6px; }
        .attr-key { font-weight: bold; background: #f8fafc; color: #475569; width: 40%; }
        
        select { width: 100%; padding: 7px; border-radius: 4px; border: 1px solid #cbd5e1; font-size: 12px; }
        label { font-size: 11px; font-weight: bold; color: #64748b; display: block; margin-bottom: 3px; }
        .btn-reset { width: 100%; padding: 8px; background: #64748b; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 8px; font-weight: bold; }
        .close-btn { color: #ef4444; cursor: pointer; font-size: 18px; font-weight: bold; }

        /* Labels Mapa */
        .label-mzna { font-size: 11px; font-weight: bold; color: #1e40af; text-shadow: 1px 1px 0 #fff; background:none; border:none; }
    </style>
</head>
<body>

<header>Geovisor de Avance Catastral</header>
<div id="map"></div>

<div class="sidebar-left">
    <div class="panel">
        <h3>Capas Catastrales</h3>
        <div id="layer-list"></div>
    </div>
    
    <div id="results-panel" class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Resultados</h3>
            <span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
        </div>
        <div id="results-content" class="scroll-area"></div>
    </div>

    <div id="floor-detail-panel" class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Categoría por Piso</h3>
            <span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
        </div>
        
        <div class="floor-selector" id="floor-btns-container"></div>
        
        <div class="scroll-area">
            <div id="floor-graphic-container">
                <svg id="svg-floor" width="140" height="140" viewBox="0 0 100 100"></svg>
            </div>
            <div id="floor-data-table"></div>
        </div>
    </div>
</div>

<div id="search-panel" class="panel">
    <h3>Búsqueda</h3>
    <div style="margin-bottom:8px">
        <label>Sector</label>
        <select id="sel-sector"><option value="">Seleccione...</option></select>
    </div>
    <div style="margin-bottom:8px">
        <label>Manzana</label>
        <select id="sel-mzna" disabled><option value="">Seleccione...</option></select>
    </div>
    <div style="margin-bottom:8px">
        <label>Lote</label>
        <select id="sel-lote" disabled><option value="">Seleccione...</option></select>
    </div>
    <button class="btn-reset" onclick="location.reload()">Limpiar Todo</button>
</div>

<script>
    var map = L.map('map', { zoomControl: false, maxZoom: 24 }).setView([-12.046, -77.042], 18);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 24, maxNativeZoom: 19 }).addTo(map);
    L.tileLayer('./ortofoto/{z}/{x}/{y}.jpg', { minZoom: 17, maxZoom: 24, maxNativeZoom: 20 }).addTo(map);

    const BASE_PATH = './data';
    let geoLayers = {};
    let currentC2Features = []; 
    let highlightLayer = L.layerGroup().addTo(map);

    const sSec = document.getElementById('sel-sector'), sMzn = document.getElementById('sel-mzna'), sLot = document.getElementById('sel-lote');

    // Estilos capas mapa
    const styles = {
        'tg_sector': { color: "#1e40af", weight: 2, fill: false },
        'tg_manzana': { color: "#f97316", weight: 2, fill: false },
        'tg_lote': { color: "#16a34a", weight: 1, fillOpacity: 0.1 },
        'tg_edifica': { color: "#d97706", weight: 1, fillOpacity: 0.2 },
        'tg_construccion': { color: "#dc2626", weight: 0.5, fillOpacity: 0.2 }
    };

    async function init() {
        const res = await fetch(`${BASE_PATH}/tg_sector.geojson`);
        const data = await res.json();
        geoLayers['tg_sector'] = L.geoJSON(data, { style: styles['tg_sector'] }).addTo(map);
        populateSectors(data);
        addLayerCheckbox('tg_sector', 'Sectores');
    }

    async function loadSectorData(sectorId) {
        const folder = `${BASE_PATH}/sector_${sectorId.padStart(2, '0')}`;
        const layers = ['tg_manzana', 'tg_lote', 'tg_edifica', 'tg_construccion', 'tg_construccion_2'];
        
        for (let key of layers) {
            try {
                const res = await fetch(`${folder}/${key}.geojson`);
                const data = await res.json();
                
                if (key === 'tg_construccion_2') {
                    currentC2Features = data.features; // Solo guardamos en memoria
                } else {
                    if (geoLayers[key]) map.removeLayer(geoLayers[key]);
                    geoLayers[key] = L.geoJSON(data, {
                        style: styles[key],
                        onEachFeature: (f, l) => {
                            if (key === 'tg_manzana') l.on('click', () => autoFilterMzn(f.properties));
                            if (key === 'tg_lote') l.on('click', () => autoFilterLote(f.properties));
                        }
                    }).addTo(map);
                }
            } catch (e) {}
        }
    }

    function executeFilter() {
        const sec = sSec.value, mzn = sMzn.value, lot = sLot.value;
        highlightLayer.clearLayers();
        
        // Filtrar visualmente en mapa
        ['tg_manzana', 'tg_lote', 'tg_edifica', 'tg_construccion'].forEach(key => {
            if (!geoLayers[key]) return;
            geoLayers[key].eachLayer(l => {
                const p = l.feature.properties;
                const match = (p.cod_sector == sec && p.cod_mzna == mzn && (!lot || p.cod_lote == lot));
                l.setStyle({ opacity: match ? 1 : 0, fillOpacity: match ? (styles[key].fillOpacity || 0) : 0 });
                if (match && lot && key === 'tg_lote') map.fitBounds(l.getBounds());
            });
        });

        // Cargar Pestaña Categorías (TG_CONSTRUCCION_2)
        if (lot) {
            const lotFeatures = currentC2Features.filter(f => 
                f.properties.cod_sector == sec && f.properties.cod_mzna == mzn && f.properties.cod_lote == lot
            );
            renderFloorPanel(lotFeatures);
        } else {
            document.getElementById('floor-detail-panel').style.display = 'none';
        }
    }

    function renderFloorPanel(features) {
        const panel = document.getElementById('floor-detail-panel');
        const btnContainer = document.getElementById('floor-btns-container');
        btnContainer.innerHTML = "";

        if (features.length === 0) { panel.style.display = 'none'; return; }
        
        panel.style.display = 'flex';
        const pisos = [...new Set(features.map(f => f.properties.piso || f.properties.cod_piso))].sort();

        pisos.forEach((p, i) => {
            const btn = document.createElement('button');
            btn.className = `floor-btn ${i === 0 ? 'active' : ''}`;
            btn.innerText = `PISO ${p}`;
            btn.onclick = () => {
                document.querySelectorAll('.floor-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                showFloorData(features.filter(f => (f.properties.piso || f.properties.cod_piso) == p));
            };
            btnContainer.appendChild(btn);
        });

        showFloorData(features.filter(f => (f.properties.piso || f.properties.cod_piso) == pisos[0]));
    }

    function showFloorData(parts) {
        const tableDiv = document.getElementById('floor-data-table');
        let html = "<table>";
        const props = parts[0].properties;
        for (let key in props) {
            html += `<tr><td class="attr-key">${key}</td><td>${props[key] || '-'}</td></tr>`;
        }
        html += "</table>";
        tableDiv.innerHTML = html;
        drawSVG(parts[0]);
    }

    function drawSVG(feature) {
        const svg = document.getElementById('svg-floor');
        svg.innerHTML = "";
        const coords = feature.geometry.coordinates[0];
        if (!coords) return;

        const lats = coords.map(c => c[1]), lngs = coords.map(c => c[0]);
        const minLat = Math.min(...lats), maxLat = Math.max(...lats);
        const minLng = Math.min(...lngs), maxLng = Math.max(...lngs);

        const pts = coords.map(c => {
            const x = ((c[0] - minLng) / (maxLng - minLng)) * 80 + 10;
            const y = 100 - (((c[1] - minLat) / (maxLat - minLat)) * 80 + 10);
            return `${x},${y}`;
        }).join(" ");

        const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        poly.setAttribute("points", pts);
        poly.setAttribute("fill", "#3b82f6");
        poly.setAttribute("fill-opacity", "0.6");
        poly.setAttribute("stroke", "#ffffff");
        poly.setAttribute("stroke-width", "1.5");
        svg.appendChild(poly);
    }

    // Handlers Buscador
    function populateSectors(data) {
        const list = [...new Set(data.features.map(f => f.properties.cod_sector))].sort();
        list.forEach(s => sSec.innerHTML += `<option value="${s}">${s}</option>`);
    }

    sSec.onchange = async () => {
        if (!sSec.value) return;
        await loadSectorData(sSec.value);
        sMzn.innerHTML = '<option value="">Seleccione...</option>';
        sMzn.disabled = false;
        const mzns = [...new Set(geoLayers['tg_manzana'].getLayers().map(l => l.feature.properties.cod_mzna))].sort();
        mzns.forEach(m => sMzn.innerHTML += `<option value="${m}">${m}</option>`);
    };

    sMzn.onchange = () => {
        sLot.innerHTML = '<option value="">Seleccione...</option>';
        sLot.disabled = false;
        const lots = [...new Set(geoLayers['tg_lote'].getLayers().filter(l => l.feature.properties.cod_mzna == sMzn.value).map(l => l.feature.properties.cod_lote))].sort();
        lots.forEach(lo => sLot.innerHTML += `<option value="${lo}">${lo}</option>`);
        executeFilter();
    };

    sLot.onchange = executeFilter;

    function addLayerCheckbox(id, label) {
        const div = document.createElement('div');
        div.style = "font-size:12px; margin-bottom:4px; display:flex; align-items:center; gap:5px;";
        div.innerHTML = `<input type="checkbox" checked id="chk-${id}"> <label for="chk-${id}">${label}</label>`;
        div.querySelector('input').onchange = (e) => {
            if (e.target.checked) map.addLayer(geoLayers[id]);
            else map.removeLayer(geoLayers[id]);
        };
        document.getElementById('layer-list').appendChild(div);
    }

    init();
</script>
</body>
</html>

